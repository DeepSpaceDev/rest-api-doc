<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-button/paper-button.html">

<dom-module id="rest-api-live-demo">
  <template>
    <style>
      :host {
        display: block;
      }

      paper-button {
        background: var(--accent-color);
        width: 100%;
      }

      paper-input {
        display: inline-block;
        width: calc(50% - 2px);
        --paper-input-container-color: #fff;
        --paper-input-container-input-color: #fff;
        --paper-input-container-focus-color: var(--accent-color);
      }

      .title {
        margin: 8px 0;
      }

      .container {
        margin-left: 8px;
      }
    </style>
    <div id="params">
      <template is="dom-if" if="[[_isSet(endpoint.params)]]">
        <div class="title">Params</div>
        <div class="container">
          <template id="paramRepeat" is="dom-repeat" items="[[endpoint.params]]">
            <paper-input label="[[item.key]]" value="[[_getFirstValue(item.values)]]"></paper-input>
          </template>
        </div>
      </template>
    </div>
    <div id="headers">
      <template is="dom-if" if="[[_isSet(endpoint.headers)]]">
        <div class="title">Headers</div>
        <div class="container">
          <template id="headerRepeat" is="dom-repeat" items="[[endpoint.headers]]">
            <paper-input label="[[item.key]]" value="[[_getFirstValue(item.values)]]"></paper-input>
          </template>
        </div>
      </template>
    </div>
    <div id="body">
      <template is="dom-if" if="[[_isSet(endpoint.body)]]">
        <div class="title">Body</div>
        <div class="container">
          <template id="bodyRepeat" is="dom-repeat" items="[[endpoint.body]]">
            <paper-input label="[[item.key]]" value="[[_getFirstValue(item.values)]]"></paper-input>
          </template>
        </div>
      </template>
    </div>
    <paper-button raised on-tap="sendRequest">Send Request</paper-button>
  </template>
  <script src="string_includes_polyfill.js"></script>
  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'rest-api-live-demo',

        properties: {
          endpoint: Object,
          baseUrl: String
        },

        observers: ['_endpointChanged(endpoint.*, baseUrl)'],

        _endpointChanged: function () {
          requestAnimationFrame(_ => {
            this.sendRequest();
          });
        },

        _getFirstValue: function (values) {
          if (values && values instanceof Array && values.length > 0) {
            return values[0];
          }
        },

        _isSet: function (obj) {
          if (obj) {
            if (obj instanceof Array)
              return obj.length > 0;
          }
          return false;
        },

        parseValue: function (val) {
          if (typeof val === 'string' && val.length > 0) {
            // Try parsing booleans and numbers
            try {
              return JSON.parse(val);
            } catch (e) {
              return val;
            }
          }
          return val;
        },

        sendRequest: function () {
          this.fire('http-result', {response: null});
          var url = this.baseUrl + this.endpoint.endpoint + '?';
          var method = this.endpoint.method.toUpperCase();
          var paramInputs = this.$.params.querySelectorAll('paper-input');
          var headerInputs = this.$.headers.querySelectorAll('paper-input');
          var bodyInputs = this.$.body.querySelectorAll('paper-input');
          var value, key, body;

          for (var p = 0; p < paramInputs.length; p++) {
            value = this.parseValue(paramInputs[p].value);
            key = paramInputs[p].label;
              url += key + '=' + value + '&';

          }
          url = url.substr(0, url.length - 1);

          var headers = new Headers();
          for (var h = 0; h < headerInputs.length; h++) {
            value = headerInputs[h].value;
            key = headerInputs[h].label;
            if (value) {
              headers.append(key, value);
            }
          }

          if (headers.has('Content-Type')) {
            var contentType = headers.get('Content-Type');
            if (contentType.includes('application/json')) {
              body = {};
              for (var bJson = 0; bJson < bodyInputs.length; bJson++) {
                value = this.parseValue(bodyInputs[bJson].value);
                key = bodyInputs[bJson].label;
                body[key] = value;
              }
              body = JSON.stringify(body);
            } else if (contentType.includes('application/x-www-form-urlencode')) {
              body = new URLSearchParams();
              for (var bUrl = 0; bUrl < bodyInputs.length; bUrl++) {
                value = this.parseValue(bodyInputs[bUrl].value);
                key = bodyInputs[bUrl].label;
                body.append(key, value);
              }
            } else if (contentType.includes('multipart/form-data')) {
              body = new FormData();
              for (var bForm = 0; bForm < bodyInputs.length; bForm++) {
                value = this.parseValue(bodyInputs[bForm].value);
                key = bodyInputs[bForm].label;
                body.append(key, value);
              }
            } else {
              if (bodyInputs.length > 0)
                body = bodyInputs[0];
              else
                body = null;
            }
          }

          var init = {
            method: method,
            headers: headers,
            body: body && method !== 'GET' && method !== 'HEAD' && method !== 'TRACE' &&
            method !== 'OPTIONS' && method !== 'CONNECT' ? body : undefined
          };
          fetch(url, init)
              .then(function (response) {
                this.fire('http-result', {response: response});
              }.bind(this))
              .catch(function (error) {
                this.fire('http-result', {response: "Request failed"});
              }.bind(this));
        }
      });
    })();
  </script>
</dom-module>
