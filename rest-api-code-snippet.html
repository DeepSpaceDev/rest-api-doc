<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../syntax-highlight/syntax-highlight.html">
<link rel="stylesheet" href="https://highlightjs.org/static/demo/styles/github-gist.css">

<dom-module id="rest-api-code-snippet">
  <template>
    <style>
      :host {
        display: block;
      }

      code#code {
        border-radius: 2px;
      }

      code#code::-webkit-scrollbar {
        height: 4px;
      }

      code#code::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.4);
        border-radius: 2px;
      }
    </style>
    <pre>
      <code id="code" class$="[[language]]"></code>
    </pre>
  </template>
  <script src="highlight.js"></script>
  <script src="string_includes_polyfill.js"></script>
  <script>
    (function () {
      'use strict';

      var GET = 'GET';
      var HEAD = 'HEAD';
      var POST = 'POST';
      var PUT = 'PUT';
      var DELETE = 'DELETE';
      var TRACE = 'TRACE';
      var OPTIONS = 'OPTIONS';
      var CONNECT = 'CONNECT';
      var PATCH = 'PATCH';

      var CURL = 'curl';
      var JS = 'js';
      var PYTHON = 'python';
      var GO = 'go';
      var RUBY = 'ruby';
      var PHP = 'php';
      var JAVA = 'java';

      Polymer({
        is: 'rest-api-code-snippet',

        properties: {
          baseUrl: String,
          endpoint: Object,
          language: {
            type: String,
            observer: '_languageChanged'
          }
        },

        observers: ['_updateSnippet(endpoint.*, language, baseUrl)'],

        parseValue: function (val) {
          if (typeof val === 'string' && val.length > 0) {
            // Try parsing booleans and numbers
            try {
              return JSON.parse(val);
            } catch (e) {
              return val;
            }
          }
          return val;
        },

        _updateSnippet: function () {
          var snippet;
          var method = this.endpoint.method;
          var url = this.baseUrl + this.endpoint.endpoint;

          var paramObjects = this.endpoint.params;
          var params = {};

          var headerObjects = this.endpoint.headers;
          var headers = {};

          var bodyObjects = this.endpoint.body;
          var body;
          var isKVBody = true;

          for (var p = 0; p < paramObjects.length; p++) {
            params[paramObjects[p].key] = paramObjects[p]['values'][0];
          }

          for (var h = 0; h < headerObjects.length; h++) {
            headers[headerObjects[h].key] = headerObjects[h]['values'][0];
          }
          if (bodyObjects instanceof Array) {
            body = {};
            for (var b = 0; b < bodyObjects.length; b++) {
              body[bodyObjects[b].key] = this.parseValue(bodyObjects[b].values[0]);
            }
          } else {
            body = bodyObjects;
          }

          switch (this.language) {
            case CURL:
              snippet = this.getCurlSnippet(method, url, params, headers, body);
              break;
            case JS:
              snippet = this.getJsSnippet(method, url, params, headers, body);
              break;
            case PYTHON:
              snippet = this.getPythonSnippet(method, url, params, headers, body);
              break;
            case GO:
              snippet = this.getGoSnippet(method, url, params, headers, body);
              break;
            case RUBY:
              snippet = this.getRubySnippet(method, url, params, headers, body);
              break;
            case PHP:
              snippet = this.getPhpSnippet(method, url, params, headers, body);
              break;
            case JAVA:
              snippet = this.getJavaSnippet(method, url, params, headers, body);
              break;
            default:
              snippet = 'Language currently not supported. Unfortunately there are no current plans to implement it ' +
                  ':( PR are welcome';
          }
          this.$.code.innerText = snippet;
          hljs.highlightBlock(this.$.code);
        },

        getCurlSnippet: function (method, url, params, headers, body) {
          var snippet = '';

          switch (method) {
            case GET:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case HEAD:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case POST:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case PUT:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case DELETE:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case TRACE:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case OPTIONS:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case CONNECT:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case PATCH:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
          }
          return snippet;
        },

        getJsSnippet: function (method, url, params, headers, body) {
          var snippet = '';
          var requestString = '', headerString = '', bodyString = '';
          var value, key;

          if (!this.isEmptyObject(params)) {
            url += '?';
            for (var param in params) {
              if (params.hasOwnProperty(param)) {
                url += param + '=' + params[param] + '&';
              }
            }
            url = url.substr(0, url.length - 1);
          }

          if (!this.isEmptyObject(headers)) {
            headerString += 'var headers = new Headers();\n';
            for (var header in headers) {
              if (headers.hasOwnProperty(header)) {
                headerString += `headers.append('${header}', '${headers[header]}');\n`;
              }
            }
            headerString += '\n';
          }

          var contentType = headers['Content-Type'];
          if (contentType && contentType.includes('application/json')) {
            bodyString = `var body = ${JSON.stringify(body, null, '\t')};\n\n`;
          } else if (contentType && contentType.includes('application/x-www-form-urlencode')) {
            bodyString = 'body = new URLSearchParams();\n';
            for (var bUrl in body) {
              if (body.hasOwnProperty(bUrl)) {
                value = body[bUrl];
                key = bUrl;
                bodyString += `body.append('${key}', ${typeof value === 'string' ? `'${value}'` : value});\n`;
              }
            }
            bodyString += '\n';
          } else if (contentType && contentType.includes('multipart/form-data')) {
            bodyString = 'body = new FormData();\n';
            for (var bForm in body) {
              if (body.hasOwnProperty(bForm)) {
                value = body[bForm];
                key = bForm;
                bodyString += `body.append('${key}', ${typeof value === 'string' ? `'${value}'` : value});\n`;
              }
            }
            bodyString += '\n';
          } else if (body && body.length > 0) {
              bodyString = `var body = '${body};\n\n`;
          }

          var init = "var init = {" +
              `\n\tmethod: '${method}'` +
              `${!this.isEmptyObject(headers) ? `,\n\theaders: headers` : ''}` +
              `${body ? `,\n\tbody: body` : ''}` +
              '\n};';
          requestString += `${init}\n\n`;
          requestString += `var request = fetch(\n\t'${url}', init);\n`;
          requestString += `request.then(result => {\n\tconsole.log(result);\n});`;

          switch (method) {
            case GET:
              snippet += headerString + requestString;
              break;
            case HEAD:
              snippet += headerString + requestString;
              break;
            case POST:
              snippet += headerString + bodyString + requestString;
              break;
            case PUT:
              snippet += headerString + bodyString + requestString;
              break;
            case DELETE:
              snippet += headerString + bodyString + requestString;
              break;
            case TRACE:
              snippet += headerString + requestString;
              break;
            case OPTIONS:
              snippet += headerString + requestString;
              break;
            case CONNECT:
              snippet += headerString + requestString;
              break;
            case PATCH:
              snippet += headerString + bodyString + requestString;
              break;
          }
          return snippet;
        },

        getPythonSnippet: function (method, url, params, headers, body) {
          var snippet ='import requests\n\n';
          var requestString = '', paramString = '', headerString = '', bodyString = '';
          var key, value;

          requestString = `response = request.get('${url}'`;

          if (!this.isEmptyObject(params)) {
            paramString = `payload = ${JSON.stringify(params, null, '\t')}\n\n`;
            requestString += ',\n\t\t\tparams=payload';
          }

          if (!this.isEmptyObject(headers)) {
            headerString = `headers = ${JSON.stringify(headers, null, '\t')}\n\n`;
            requestString += ', headers=headers';
          }

          var contentType = headers['Content-Type'];
          if (contentType &&
              (contentType.includes('application/json') || contentType.includes('application/x-www-form-urlencode'))) {
            bodyString = `body = ${JSON.stringify(body, null, '\t')}\n\n`;
            requestString += ', data=body';
          } else if (contentType && contentType.includes('multipart/form-data')) {
            bodyString = 'body = (';
            for (var bForm in body) {
              if (body.hasOwnProperty(bForm)) {
                value = body[bForm];
                key = bForm;
                bodyString += `\n\t('${key}', ${typeof value === 'string' ? `'${value}'` : value}),`;
              }
            }
            bodyString = bodyString.substr(0, bodyString.length - 1);
            bodyString += '\n)\n\n';
            requestString += ', files=body';
          } else if (body && body.length > 0) {
            bodyString = `body = '${body}';\n\n`;
            requestString += ', data=body';
          }
          bodyString = bodyString.split('true').join('True').split('false').join('False');

          requestString += ')\n';

          switch (method) {
            case GET:
              snippet += paramString + headerString + requestString;
              break;
            case HEAD:
              snippet += paramString + headerString + requestString;
              break;
            case POST:
              snippet += paramString + headerString + bodyString + requestString;
              break;
            case PUT:
              snippet += paramString + headerString + bodyString + requestString;
              break;
            case DELETE:
              snippet += paramString + headerString + bodyString + requestString;
              break;
            case TRACE:
              snippet += paramString + headerString + requestString;
              break;
            case OPTIONS:
              snippet += paramString + headerString + requestString;
              break;
            case CONNECT:
              snippet += paramString + headerString + requestString;
              break;
            case PATCH:
              snippet += paramString + headerString + bodyString + requestString;
              break;
          }
          return snippet;
        },

        getGoSnippet: function (method, url, params, headers, body) {
          var snippet = '';

          switch (method) {
            case GET:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case HEAD:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case POST:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case PUT:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case DELETE:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case TRACE:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case OPTIONS:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case CONNECT:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case PATCH:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
          }
          return snippet;
        },

        getRubySnippet: function (method, url, params, headers, body) {
          var snippet = 'require \'rest-client\'\n\n';
          var requestString = '', headerString = '', bodyString = '';

          requestString += `response = RestClient.${method.toLowerCase()} '${url}' `;

          if (!this.isEmptyObject(params)) {
            url += '?';
            for (var param in params) {
              if (params.hasOwnProperty(param)) {
                url += param + '=' + params[param] + '&';
              }
            }
            url = url.substr(0, url.length - 1);
          }

          if (!this.isEmptyObject(headers)) {
            headerString += 'headers = {';
            for (var header in headers) {
              if (headers.hasOwnProperty(header)) {
                headerString += '\n\t\'' + header + '\': ' + headers[header] + ',';
              }
            }
            headerString = headerString.substr(0, headerString.length - 1);
            headerString += '\n}\n\n';
            requestString += 'headers=headers ';
          }

          switch (method) {
            case GET:
              snippet += headerString + requestString;
              snippet = 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case HEAD:
              snippet += headerString + requestString;
              snippet = 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case POST:
              snippet = 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case PUT:
              snippet = 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case DELETE:
              snippet += headerString + requestString;
              snippet = 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case TRACE:
              snippet += headerString + requestString;
              snippet = 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case OPTIONS:
              snippet += headerString + requestString;
              snippet = 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case CONNECT:
              snippet += headerString + requestString;
              snippet = 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case PATCH:
              snippet = 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
          }
          return snippet;
        },

        getPhpSnippet: function (method, url, params, headers, body) {
          var snippet = '';

          switch (method) {
            case GET:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case HEAD:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case POST:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case PUT:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case DELETE:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case TRACE:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case OPTIONS:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case CONNECT:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case PATCH:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
          }
          return snippet;
        },

        getJavaSnippet: function (method, url, params, headers, body) {
          var snippet = '';

          switch (method) {
            case GET:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case HEAD:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case POST:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case PUT:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case DELETE:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case TRACE:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case OPTIONS:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case CONNECT:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
            case PATCH:
              snippet += 'Currently not supported by the doc :( Stay tuned ;) PR\'s are welcome';
              break;
          }
          return snippet;
        },

        isEmptyObject: function (obj) {
          for (var prop in obj) {
            if (Object.prototype.hasOwnProperty.call(obj, prop)) {
              return false;
            }
          }
          return true;
        }

      });
    })();
  </script>
</dom-module>
